version: "2.4"

services:
  zellostream:
    build:
      context: .
      dockerfile: zellostream/Dockerfile
    restart: unless-stopped
    network_mode: host
    volumes:
      - data:/data               # holds logs and runtime data
    environment:
      # Set real values as Balena Service Variables (Device or Fleet level)
      - ZELLO_USERNAME
      - ZELLO_PASSWORD
      - ZELLO_CHANNEL
      - ZELLO_WORK_ACCOUNT      # empty if consumer Zello
      - UDP_PORT=9123
      - INPUT_RATE=8000
      - ZELLO_RATE=16000
      - AUDIO_THRESHOLD=700     # from client config
      - VOX_SILENCE_MS=2000     # = 2 seconds
    healthcheck:
      test: ["CMD-SHELL", "ss -u -l | grep -q ':9123' || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 5
    labels:
      io.balena.features.dbus: '1'

volumes:
  data:
